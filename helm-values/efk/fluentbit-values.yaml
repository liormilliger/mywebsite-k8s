# This values.yaml file configures Fluent Bit to run as a DaemonSet,
# collect container logs, enrich them with Kubernetes metadata, and
# securely send them to an Elasticsearch service.

# Inject ELASTICSEARCH_USERNAME and ELASTICSEARCH_PASSWORD as environment variables
# from the secret created by the Elasticsearch Helm chart.
env:
  - name: ELASTICSEARCH_USERNAME
    valueFrom:
      secretKeyRef:
        name: elasticsearch-master-credentials
        key: username
  - name: ELASTICSEARCH_PASSWORD
    valueFrom:
      secretKeyRef:
        name: elasticsearch-master-credentials
        key: password

# Create a volume from the secret containing the Elasticsearch CA certificate.
extraVolumes:
  - name: elastic-certs
    secret:
      secretName: elasticsearch-master-certs

# Mount the certificate volume into the Fluent Bit container so it can be referenced in the config.
extraVolumeMounts:
  - name: elastic-certs
    mountPath: /fluent-bit/etc/certs/
    readOnly: true

# Main Fluent Bit configuration for inputs, filters, and outputs.
config:
  inputs: |
    [INPUT]
        Name              tail
        Tag               kube.*
        Path              /var/log/containers/*.log
        Parser            docker
        DB                /var/log/flb_kube.db
        Mem_Buf_Limit     5MB
        Skip_Long_Lines   On
        Refresh_Interval  10

  filters: |
    [FILTER]
        Name                kubernetes
        Match               kube.*
        Kube_URL            https://kubernetes.default.svc:443
        Kube_CA_File        /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        Kube_Token_File     /var/run/secrets/kubernetes.io/serviceaccount/token
        Kube_Tag_Prefix     kube.var.log.containers.
        Merge_Log           On
        Merge_Log_Key       log_processed
        K8S-Logging.Parser  On
        K8S-Logging.Exclude Off

  outputs: |
    [OUTPUT]
        Name            es
        Match           kube.*
        Host            elasticsearch-master
        Port            9200
        # These variables are expanded from the 'env' section above
        Http_User       ${ELASTICSEARCH_USERNAME}
        Http_Passwd     ${ELASTICSEARCH_PASSWORD}
        # Enable TLS and configure verification
        TLS             On
        TLS.Verify      On
        TLS.CA_File     /fluent-bit/etc/certs/ca.crt
        # Standard settings for Elastic output
        Suppress_Type_Name On
        Replace_Dots    On
        Retry_Limit     False
        